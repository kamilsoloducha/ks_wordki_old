trigger:
  branches:
   include:
     - master
  paths:
    include:
     - 'client/*'
  

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: DockerCompose@0
  displayName: Build
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'docker-hub-connection'
    dockerComposeFile: 'client/build/docker/docker-compose.build.yml'
    action: 'Run a Docker Compose command'
    dockerComposeCommand: up
- task: DockerCompose@0
  displayName: Run Tests
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'docker-hub-connection'
    dockerComposeFile: 'client/build/docker/docker-compose.test.yml'
    action: 'Run a Docker Compose command'
    dockerComposeCommand: up
- task: CmdLine@2
  inputs:
    script: 'docker cp wordki-client/ci/build:/dist/testresult/ ./dist/testresult/'
- task: CmdLine@2
  inputs:
    script: 'ls -R $(System.DefaultWorkingDirectory) | grep ":$" | sed -e ''s/:$//'' -e ''s/[^-][^\/]*\//--/g'' -e ''s/^/   /'' -e ''s/-/|/'''
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/TEST-*.xml'
    searchFolder: '$(System.DefaultWorkingDirectory)'
    testRunTitle: 'Unit tests'
- task: DockerCompose@0
  displayName: Release
  inputs:
    containerregistrytype: 'Container Registry'
    dockerRegistryEndpoint: 'docker-hub-connection'
    dockerComposeFile: 'client/build/docker/docker-compose.release.yml'
    action: 'Run a Docker Compose command'
    dockerComposeCommand: build
- task: Docker@2
  displayName: Login to Docker Hub
  inputs:
    containerRegistry: 'docker-hub-connection'
    command: 'login'
- task: Docker@2
  displayName: Push
  inputs:
    containerRegistry: 'docker-hub-connection'
    repository: 'vesper0990/wordki'
    command: 'push'
    tags: |
      $(Build.BuildId)